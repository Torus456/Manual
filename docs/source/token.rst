Инструкция по работе с сервисом токенизации наименований объектов
==================================================================

.. |Токен| image:: _static/icons/token.png
.. |ТокенОД| image:: _static/icons/token-od.png
.. |ТокенЗн| image:: _static/icons/token-zn.png
.. |Заполнить пользовательскую токенизацию| image:: _static/icons/twoPerson.png
.. |Excel| image:: _static/icons/xl.png
.. |Отправить данные| image:: _static/icons/send.png
.. |Удалить| image:: _static/icons/del.png
.. |Comp| image:: _static/icons/comp.png
.. |Comp_gr| image:: _static/icons/comp_gr.png
.. |slov| image:: _static/icons/slov.png
.. |mash| image:: _static/icons/mash.png
.. |sv1| image:: _static/icons/sv1.png
.. |sv2| image:: _static/icons/sv2.png
.. |work_with_obj| image:: _static/icons/work_with_obj.png
.. |deblock| image:: _static/icons/deblock.png


Токенизация 
 Это процесс разделения исходного текста на токены с преобразованиями.
Токены
 Это кусочки исходного текста, которые были подвержены некоторым преобразованиям.

Мы разделяем исходный (исторический) текст на кусочки, чтобы понять: какому ОД и значению ОД соответствует тот или иной кусочек исходного текста.
Этот процесс незаметно происходит в голове у эксперта, который разделяет исходный текст (равно обрабатывает), и понимает, какие части текста указывают на соответствующие значения ОД, а какие не указывают на значения ОД, и какие не указывают ни на что и являются своеобразным “мусором”. При этом эксперт может переставлять части текста местами, объединять и разделять их, устраняя неточности исходного текста.
Формализовав данный процесс, мы получили сервис токенизации наименований объектов, который учитывает набор и частоту встречаемости всех значений ОД в классе, а для обработанных объектов еще значения ОД этих объектов. 

Заполнение машинной и пользовательской токенизации
--------------------------------------------------

Прежде всего нам необходимо обучить модель на пользовательской токенизации. На форме «Справочник объектов» необходимо выделить все объекты класса со статусом 1, затем нажать кнопку «Токенизация наименования» |Токен|.

.. image:: _static/screens/token01.png

На форме «Токенизация наименования» мы наблюдаем таблицу в которой представлены:

* Наименование - исходный (исторический) текст.

* Машинная токенизация - текст из которого удаляются все символы кроме: пробела, точки, букв и цифр.

* Пользовательская токенизация - текст на основе которого будет происходить обучение модели. 
  
.. image:: _static/screens/token02.png

Далее необходимо запустить кнопку «Формирование словаря токенизации» |slov|. Кнопка запускает сбор статистики использования токенов по классу на основе пользовательской токенизации, в случае ее отсутствия анализирует машинную токенизацию. При нажатии кнопки выводится информационное сообщение «Статистика по классу пересобирается. Необходимо обновить данные», нажмите «Ок». Для обновления данных используется кнопка «Обновить» (F5).

.. image:: _static/screens/token21.png

Затем заполняем или обновляем машинную токенизацию. Для этого необходимо выделить все объекты и нажать на кнопку «Заполнить машинную токенизацию» |mash| на панели инструментов. 

.. image:: _static/screens/token32.png


Затем заполняем пользовательскую токенизацию путем копирования машинной токенизации. Для этого необходимо выделить все объекты и нажать на кнопку «Заполнить пользовательскую токенизацию» |Заполнить пользовательскую токенизацию| на панели инструментов. 

.. image:: _static/screens/token03.png

Машинную токенизацию мы изменить не можем, она формируется автоматически. Пользовательскую токенизацию мы можем изменить, чтобы обучение модели происходило более эффективно (например убрать лишние данные в токенизированном наименовании, которые могут ошибочно влиять на процесс обучения, либо скорректировать данные).  Подробнее в разделе `Исправление токенизации`_.

Обучение модели на основе пользовательской токенизации
------------------------------------------------------

После заполнения пользовательской токенизации возвращаемся на форму «Справочник объектов» и на панели инструментов нажимаем на кнопку «Обучить IBM-модель для класса» |Comp|

На открывшейся форме «Работа с IBM-моделью» выбираем действие «**Обучить модель**» и тип токенизации «**Пользовательская токенизация**». Затем нажимаем на кнопку Отправить данные |Отправить данные|.

.. image:: _static/screens/token30.png

Ожидаем письмо об окончании обучения модели.

.. image:: _static/screens/token07.png

Далее форме «Работа с IBM-моделью» выбираем действие «**Получить метрики**». Затем нажимаем на кнопку Отправить данные |Отправить данные|.

.. image:: _static/screens/token31.png

Ожидаем письмо об окончании подсчета метрик.


Заполнение связей между токенами и значениями ОД вручную
--------------------------------------------------------

Возвращаемся на форму «Токенизация наименования». Рассмотрим блоки которые расположены в нижней части формы. 

В блоке «Связь токенов зо значениями объекта» мы видим разделенный последовательно (попозиционно) на токены исходный текст объекта.

.. image:: _static/screens/token17.png

В блоке «Статистика токенов по IBM-модели» мы видим ОД, значения ОД и произведение трех вероятностей:

* T - вероятность совместной встречаемости токена и значения ОД;

* A - вероятность встречаемости значения ОД на данной позиции при заданной длине текста;

* V - вероятность появления данного значения ОД.

.. image:: _static/screens/token18.png

Значения расположены в порядке убывания произведения вероятностей. На основании данного произведения будет производиться автоматическое заполнение связей. Голубым цветом выделены поля которые соответсвуют ОД и значениям ОД присвоенным для объекта. Мы можем вручную перетащить строку со значением ОД из блока «Статистика токенов по IBM-модели» в блок «Связь токенов зо значениями объекта». При этом если объекту в выбранном ОД было присвоено другое значение, либо в выбранном ОД отсутствовало значение, то объекту будет присвоено выбранное значение ОД и создана соответствующая связь.


.. image:: _static/screens/token19.png


Заполнение связей между токенами и значениями ОД автоматически
---------------------------------------------------------------

Автоматическое заполнения связей возможно попозиционно на форме «Токенизация наименования». Для этого необходимо выбрать объект и нажать на кнопку «Заполнить отсутсвующие связи на основе статистики» |Comp|. 

.. image:: _static/screens/token20.png

Чтобы заполнить связи сразу для всего класса необходимо перейти в функциональный модуль.

.. image:: _static/screens/token08.png

Запускаем функциональный модуль 2636 «Заполнение связей токенов со значениями объектов по классу»

.. image:: _static/screens/token09.png

Заполняем значения параметров «Множество», «Классификация», «Класс», нажимаем кнопку «ОК»

.. image:: _static/screens/token10.png


Удаление лишних связей в разрезе ОД
-------------------------------------

После автоматического заполнения связей необходимо отвязать некорректные. Это можно сделать из формы «Основания деления класса», выделяем ОД и нажимаем кнопку «Токены, связанные с ОД», либо сочетание клавиш Ctrl+Shift+T

.. image:: _static/screens/token11.png

На открывшейся форме «Токены, связанные с ОД» мы видим таблицу на которой отображены **текст привязанного токена**, **количесвто связей** данного текста с объектами обучающей выборки, вхождение данного текста **в домен** выбранного основания деления (те что входят отмечены символом "V"). 

Выделяем те связи которые мы считаем лишними и нажимаем кнопку «Удалить связь токена со значением ОД» |Удалить| либо клавишу Delete.

.. image:: _static/screens/token12.png

Чтобы просмотреть объекты обучающей выборки которые привязаны к конкретному тексту необходимо выделить его и нажать на кнопку «Открыть связаннные с токеном объекты» |Токен| на панели инструментов либо сочетание клавиш Ctrl+Shift+T.

.. image:: _static/screens/token13.png

Удаление лишних связей в разрезе значений ОД
----------------------------------------------

Если домен значений ОД содержит небольшое количество значений, то следует отвязать неккоректные связи и на уровне значений. Для этого переходим на форму «Справочник значений ОД» и нажимаем на кнопку «Токены, связанные со значением ОД» |ТокенЗн| либо сочетание клавиш Ctrl+Shift+T, предварительно выделив строку с ОД.

.. image:: _static/screens/token14.png

На открывшейся форме «Токены, связанные со значением ОД» мы видим таблицу на которой отображены **текст привязанного токена**, **количесвто связей** данного текста с объектами обучающей выборки, **T** - вероятность совместной встречаемости токена и значения ОД. 

Выделяем те связи которые мы считаем лишними и нажимаем кнопку «Удалить связь токена со значениями ОД объекта» |Удалить| либо клавишу Delete.

.. image:: _static/screens/token15.png

Чтобы просмотреть объекты обучающей выборки которые привязаны к конкретному тексту необходимо выделить его и нажать на кнопку «Открыть связаннные с токеном объекты» |Токен| на панели инструментов либо сочетание клавиш Ctrl+Shift+T.

.. attention:: Каждый раз при внесени довольно большого количества изменений (изменения токенов, проставление и удаление связей) в токенизацию необходимо проводить `Обучение модели на основе пользовательской токенизации`_. Т.е. ее надо проводить как минимум перед началом всех работ, после чистки связей токенов со значениями ОД и после окончания работ по токенизации класса.

Массовая обработка токенизированных наименований в разрезе значений ОД
----------------------------------------------------------------------

На форме «Токенизация наименования» возможна массовое создание, редактирование, удаление связей между токенами и значениями ОД. 

Для массового удаления связей необходимо выделить несколько объектов, также выделить связь на блоке «Связь токенов зо значениями объекта» и нажать кнопку "Удалить связь токена со значениями ОД объекта" |Удалить| на панели инструментов или в контекстном меню, либо нажать клавишу Delete.

.. image:: _static/screens/token22.png

Для массового создания связей нужно выделить несколько объектов и перетащить строку со значением ОД из блока «Статистика токенов по IBM-модели» в блок «Связь токенов зо значениями объекта».

.. image:: _static/screens/token23.png

Массовая обработка токенизированных наименований ограничена количеством объектов не более 1000. 


Создание прямых связей между токенами и значениями ОД
------------------------------------------------------

Прямая связь между токеном и значением ОД
 показывает, что если среди токенов объекта есть данный токен, то с наибольшей вероятностью он означает данное значение ОД.

Проставить прямую связь можно двумя способами.

1) На форме «Токенизация наименования» выделить объект, также выделить связь на блоке «Связь токенов зо значениями объекта» и нажать на кнопку «Добавить прямую связь между токеном и значением ОД» |sv1|. Строка с прямой связью будет выделена зеленым цветом.  Для удаления связи нажать на кнопку «Удалить прямую связь токена со значением ОД» |sv2|. 

.. image:: _static/screens/token25.png

2) На форме «Токены, связанные со значением ОД» которую можно открыть с формы «Справочник значений ОД» выделить необходимое поле и нажать на кнопку «Добавить прямую связь между токеном и значением ОД» |sv1|. Строка с прямой связью будет выделена зеленым цветом. Для удаления связи нажать на кнопку «Удалить прямую связь токена со значением ОД» |sv2|. Подробнее о форме в разделе `Удаление лишних связей в разрезе значений ОД`_
   
.. image:: _static/screens/token26.png

Когда в классе уже создано достаточное количество прямых связей можно ограничить заполнение отсутствующих связей на основе статистики только прямыми связями. Для этого в блоке «Связь токенов зо значениями объекта» необходимо нажать на кнопку «Заполнить отсутствующие прямые связи на основе статистики» |Comp_gr|.

.. image:: _static/screens/token29.png


.. note:: Пример отношения 1:1 в рамках привязки токена к домену конкретного ОД.  Домен из положительных и отрицательных чисел. В домене есть числа -20, 20. В исторических данных написано "-20..20", токены 20 и 20. К токену 20 мы привяжем -20 из ОД мин.значение и к токену 20 мы привяжем 20 из ОД макс.значение. В данном случае в рамках ОД мин.значение, т.к. в домене есть и -20 и 20, токен 20 не дает однозначно понять, какое значение привязать. мы поняли, что надо привязать -20 не ориентируясь только на ну информацию, что есть в токене, но и на упущенную в токене информацию, т.е. знак минус. Т.к. токен 20 не определяет однозначно значение ОД, связь не прямая. В домене макс.значения нет отрицательных чисел, токен 20 однозначно определяет значение 20. В рамках этого ОД связь однозначная, т.е. прямая.

Другой пример:

.. note:: В классе молотки токен молоток в любом его написании имеет прямую связь с значением Вида продукции "Молоток". Токены кирочка, кирка, МКИ, кироч и т.д. имеет прямую связь значением Тип молотка "Кирочка". Токен 11042 имеет прямую связь со значением ОД Стандарт "ГОСТ 11042". ОД "Масса бойка" в граммах. Токен 600 будет иметь прямую связь со значеним ОД 600, а токен 0,6 будет иметь прямую связь с 600. При этом если в домене этого же ОД было бы значение 0,6, то 0,6 и 600 это не прямая связь.


Обработка отсутствующих связей между токенами и значениями ОД
--------------------------------------------------------------

Для того чтобы модель обучалась более эффективно требуется корректировка фасетной классификации объектов, блокировка заполненных некорректных значений ОД объектов. 

* Значениям ОД взятым из полного наименования или других дополнительных полей ставим vso=1
* Значениям ОД взятым в результате доопределения ставим vso=2
* Значения ОД которые по какой-либо причине не были заполнены заполняем. 
  
Редактирование объектов возможно с формы «Токенизация наименования». Для этого необходимо выделить объект и нажать на кнопку «Редактирование классификации объектов» |work_with_obj| или сочетание клавиш Ctrl+Alt+C
  
.. image:: _static/screens/token27.png

Для удобства можно добавить в отображение столбец, в котором будут выведены ИД ОД, которые заполнены у объектов, но не имеют привязок к токенам:
::

     (SELECT LISTAGG(v.dvs_id, ', ') WITHIN GROUP (ORDER BY v.dvs_id)
     --LISTAGG(v.dvs_id  ': '  NVL(n.valchar, n.valnum), '; ') WITHIN GROUP (ORDER BY v.dvs_id)
     FROM vso v, vsn n
     WHERE v.mlt_id = :MLT_ID 
     AND v.clf_id = :CLF_ID 
     AND v.cls_id = :CLS_ID 
     AND v.status <> 2 
     AND v.vsn_id <> 0 
     AND v.obj_id = a.obj_id
     AND n.mlt_id = :MLT_ID
     AND n.sgn_id = v.sgn_id
     AND n.vsn_id = v.vsn_id
     AND NOT EXISTS (
       SELECT NULL 
       FROM vcl 
       WHERE mlt_id = v.mlt_id 
       AND clf_id = v.clf_id 
       AND cls_id = v.cls_id
       AND dvs_id = v.dvs_id
       AND sgn_id = v.sgn_id
       AND vsn_id = v.vsn_id
       AND obj_id = v.obj_id
       )
     )

Деблокирование связей между токенами и значениями ОД
-----------------------------------------------------

Все обработанные связи должны быть деблокированы, таким образом мы понимаем, что класс закончен. Когда мы заполненяем связи между токенами и значениями ОД вручную, то статус автоматически изменяется на 1. Все связи которые присвоены автоматически мы должны проверить и либо отвязать, либо деблокировать.

Деблокирование связей происходит на форме «Токенизация наименования». Для этого необходимо выделить необходимую связь и нажать на кнопку «Деблокировать связь токена со значением объекта» |deblock|

.. image:: _static/screens/token28.png

Исправление токенизации
------------------------

Исправление токенизации возможно в режиме редактирования текста по одному объекту, в режиме замены по любому числу выделенных объектов или SQL-запросом к таблице TON.
По опыту тестирования инструмента основные операции в исправлении токенизации:

* возврат удаленного символа (часто это единица измерения после числа, которой нет в значениях ОД),

* разделение токенов (несколько слов могут быть слеплены в одно, например, из-за сокращений),

* объединение токенов (часть слова может быть отделена, так как сама является валидным токеном, либо значение ОД является диапазоном).

В целом важно понимать, что токенизированное наименование «стремится» к нормализованному.

Чтобы массово изменить тексты пользовательской токенизации используется блок «Заменить текст токенизации». В поле «Искомый текст» вводим текст который требует коррекции, в поле «Заменить на» обновленный текст. Далее выделяем записи в которых необходимо произвести замену и нажимаем кнопку «Заменить». 

.. image:: _static/screens/token16.png

Получение метрик
----------------

Для контроля эффективности выполненных работ разработан новый сервис «Получить метрики» - подсчет метрик по распознаванию значений ОД в классе. 

На форме «Справочник объектов» и на панели инструментов нажимаем на кнопку «Обучить IBM-модель для класса» |Comp|

На открывшейся форме «Работа с IBM-моделью» выбираем действие «**Получить метрики**». Затем нажимаем на кнопку Отправить данные |Отправить данные|.

.. image:: _static/screens/token31.png

Ожидаем письмо об окончании подсчета метрик.

.. attention:: Не стоит при каждом изменении данных смотреть метрики.

